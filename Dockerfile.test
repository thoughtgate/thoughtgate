# Test Dockerfile - includes mock_mcp for K8s integration tests
#
# This image is used by CI for Kubernetes integration tests.
# It includes both thoughtgate and mock_mcp binaries.
#
# Production deployments should use the main Dockerfile instead.

# Build stage
FROM rust:1.93 AS builder
WORKDIR /app

# Copy only dependency manifests first (for caching)
COPY Cargo.toml Cargo.lock ./

# Create dummy source files to build dependencies
# Note: Must match real project module structure to avoid E0761 conflicts
RUN mkdir -p src/bin src/error && \
    echo "fn main() {}" > src/main.rs && \
    echo "fn main() {}" > src/bin/mock_mcp.rs && \
    echo "pub mod error; pub mod logging_layer; pub mod proxy_service;" > src/lib.rs && \
    echo "pub struct ProxyService;" > src/proxy_service.rs && \
    echo "pub enum ProxyError {}" > src/error/mod.rs && \
    echo "pub struct LoggingLayer;" > src/logging_layer.rs

# Build dependencies (this layer will be cached unless Cargo.toml/Cargo.lock change)
RUN cargo build --release --locked --bin thoughtgate || true && \
    cargo build --release --locked --bin mock_mcp --features mock || true

# Now copy actual source code
COPY . .

# Remove dummy binaries to force rebuild with real source
RUN rm -rf target/release/thoughtgate target/release/mock_mcp \
           target/release/deps/thoughtgate* target/release/deps/mock_mcp*

# Build both thoughtgate and mock_mcp with real source
RUN cargo build --release --locked --bin thoughtgate && \
    cargo build --release --locked --bin mock_mcp --features mock

# Test stage - minimal Debian image with both binaries
FROM debian:bookworm-slim

# Install CA certificates for HTTPS connections
RUN apt-get update && apt-get install -y --no-install-recommends ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# Copy both binaries
COPY --from=builder /app/target/release/thoughtgate /thoughtgate
COPY --from=builder /app/target/release/mock_mcp /mock_mcp

# Run as non-root user (nobody already exists as UID 65534 in Debian)
USER nobody

# Expose default ports
EXPOSE 7467 7468 7469 8080

ENTRYPOINT ["/thoughtgate"]
