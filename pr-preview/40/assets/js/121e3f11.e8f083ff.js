"use strict";(globalThis.webpackChunkthoughtgate_docs=globalThis.webpackChunkthoughtgate_docs||[]).push([[385],{7967(e,t,n){n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>c,frontMatter:()=>o,metadata:()=>s,toc:()=>h});const s=JSON.parse('{"id":"how-to/monitor","title":"Monitor ThoughtGate","description":"This guide explains how to monitor ThoughtGate in production environments.","source":"@site/docs/how-to/monitor.md","sourceDirName":"how-to","slug":"/how-to/monitor","permalink":"/pr-preview/40/docs/how-to/monitor","draft":false,"unlisted":false,"editUrl":"https://github.com/thoughtgate/thoughtgate/tree/main/website/docs/how-to/monitor.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6},"sidebar":"docsSidebar","previous":{"title":"Deploy to Kubernetes","permalink":"/pr-preview/40/docs/how-to/deploy-kubernetes"},"next":{"title":"Troubleshoot Common Issues","permalink":"/pr-preview/40/docs/how-to/troubleshoot"}}');var r=n(4848),i=n(8453);const o={sidebar_position:6},a="Monitor ThoughtGate",l={},h=[{value:"Health Endpoints",id:"health-endpoints",level:2},{value:"Kubernetes Probe Configuration",id:"kubernetes-probe-configuration",level:3},{value:"Health vs Ready",id:"health-vs-ready",level:3},{value:"Prometheus Metrics",id:"prometheus-metrics",level:2},{value:"Request Metrics",id:"request-metrics",level:3},{value:"Approval Metrics",id:"approval-metrics",level:3},{value:"Upstream Metrics",id:"upstream-metrics",level:3},{value:"Traffic Path Metrics",id:"traffic-path-metrics",level:3},{value:"Prometheus Scrape Configuration",id:"prometheus-scrape-configuration",level:2},{value:"Grafana Dashboard",id:"grafana-dashboard",level:2},{value:"Key Panels",id:"key-panels",level:3},{value:"Recommended Alerts",id:"recommended-alerts",level:3},{value:"Logging",id:"logging",level:2},{value:"Log Levels",id:"log-levels",level:3},{value:"Sensitive Data",id:"sensitive-data",level:3},{value:"Distributed Tracing",id:"distributed-tracing",level:2},{value:"Troubleshooting with Metrics",id:"troubleshooting-with-metrics",level:2},{value:"&quot;Requests are slow&quot;",id:"requests-are-slow",level:3},{value:"&quot;Approvals are getting stuck&quot;",id:"approvals-are-getting-stuck",level:3},{value:"&quot;High memory usage&quot;",id:"high-memory-usage",level:3},{value:"Resource Recommendations",id:"resource-recommendations",level:2},{value:"Next Steps",id:"next-steps",level:2}];function d(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"monitor-thoughtgate",children:"Monitor ThoughtGate"})}),"\n",(0,r.jsx)(t.p,{children:"This guide explains how to monitor ThoughtGate in production environments."}),"\n",(0,r.jsx)(t.h2,{id:"health-endpoints",children:"Health Endpoints"}),"\n",(0,r.jsx)(t.p,{children:"ThoughtGate exposes health endpoints on the admin port (default: 7469):"}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:"Endpoint"}),(0,r.jsx)(t.th,{children:"Purpose"}),(0,r.jsx)(t.th,{children:"Kubernetes Use"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"GET /health"})}),(0,r.jsx)(t.td,{children:"Liveness probe"}),(0,r.jsx)(t.td,{children:"Restart if unhealthy"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"GET /ready"})}),(0,r.jsx)(t.td,{children:"Readiness probe"}),(0,r.jsx)(t.td,{children:"Remove from service if not ready"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"GET /metrics"})}),(0,r.jsx)(t.td,{children:"Prometheus metrics"}),(0,r.jsx)(t.td,{children:"Scrape for monitoring"})]})]})]}),"\n",(0,r.jsx)(t.h3,{id:"kubernetes-probe-configuration",children:"Kubernetes Probe Configuration"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Pod\nspec:\n  containers:\n    - name: thoughtgate\n      livenessProbe:\n        httpGet:\n          path: /health\n          port: 7469\n        initialDelaySeconds: 5\n        periodSeconds: 10\n        failureThreshold: 3\n      readinessProbe:\n        httpGet:\n          path: /ready\n          port: 7469\n        initialDelaySeconds: 5\n        periodSeconds: 5\n        failureThreshold: 2\n"})}),"\n",(0,r.jsx)(t.h3,{id:"health-vs-ready",children:"Health vs Ready"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:(0,r.jsx)(t.code,{children:"/health"})})," \u2014 Returns 200 if the process is alive. Use for liveness probes."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:(0,r.jsx)(t.code,{children:"/ready"})})," \u2014 Returns 200 only when:","\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"Configuration is loaded"}),"\n",(0,r.jsx)(t.li,{children:"Upstream is reachable"}),"\n",(0,r.jsx)(t.li,{children:"Task store is initialized"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["If ",(0,r.jsx)(t.code,{children:"/ready"})," returns 503, ThoughtGate won't receive traffic until it becomes ready."]}),"\n",(0,r.jsx)(t.h2,{id:"prometheus-metrics",children:"Prometheus Metrics"}),"\n",(0,r.jsxs)(t.p,{children:["ThoughtGate exposes Prometheus-format metrics on ",(0,r.jsx)(t.code,{children:"GET /metrics"})," (port 7469)."]}),"\n",(0,r.jsx)(t.h3,{id:"request-metrics",children:"Request Metrics"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'# Request counts by action\nthoughtgate_requests_total{action="forward"}\nthoughtgate_requests_total{action="deny"}\nthoughtgate_requests_total{action="approve"}\n\n# Request latency histogram\nthoughtgate_request_duration_seconds{quantile="0.5"}\nthoughtgate_request_duration_seconds{quantile="0.95"}\nthoughtgate_request_duration_seconds{quantile="0.99"}\n'})}),"\n",(0,r.jsx)(t.h3,{id:"approval-metrics",children:"Approval Metrics"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'# Approval outcomes\nthoughtgate_approval_total{result="approved"}\nthoughtgate_approval_total{result="rejected"}\nthoughtgate_approval_total{result="timeout"}\n\n# Active tasks waiting for approval\nthoughtgate_tasks_active\n'})}),"\n",(0,r.jsx)(t.h3,{id:"upstream-metrics",children:"Upstream Metrics"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'# Upstream request outcomes\nthoughtgate_upstream_requests_total{status="success"}\nthoughtgate_upstream_requests_total{status="error"}\nthoughtgate_upstream_requests_total{status="timeout"}\n'})}),"\n",(0,r.jsx)(t.h3,{id:"traffic-path-metrics",children:"Traffic Path Metrics"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'# Bytes transferred\ngreen_path_bytes_total{direction="upload"}\ngreen_path_bytes_total{direction="download"}\n\n# Active streams\ngreen_path_streams_active\n\n# Time to first byte\ngreen_path_ttfb_seconds\n'})}),"\n",(0,r.jsx)(t.h2,{id:"prometheus-scrape-configuration",children:"Prometheus Scrape Configuration"}),"\n",(0,r.jsx)(t.p,{children:"Add ThoughtGate to your Prometheus scrape config:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:"# prometheus.yml\nscrape_configs:\n  - job_name: 'thoughtgate'\n    kubernetes_sd_configs:\n      - role: pod\n    relabel_configs:\n      - source_labels: [__meta_kubernetes_pod_container_name]\n        regex: thoughtgate\n        action: keep\n      - source_labels: [__meta_kubernetes_pod_container_port_name]\n        regex: admin\n        action: keep\n"})}),"\n",(0,r.jsx)(t.p,{children:"Or for static targets:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:"scrape_configs:\n  - job_name: 'thoughtgate'\n    static_configs:\n      - targets: ['localhost:7469']\n"})}),"\n",(0,r.jsx)(t.h2,{id:"grafana-dashboard",children:"Grafana Dashboard"}),"\n",(0,r.jsx)(t.h3,{id:"key-panels",children:"Key Panels"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Request Rate by Action"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-promql",children:"sum(rate(thoughtgate_requests_total[5m])) by (action)\n"})}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Request Latency (p95)"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-promql",children:"histogram_quantile(0.95, rate(thoughtgate_request_duration_seconds_bucket[5m]))\n"})}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Approval Wait Time"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-promql",children:"histogram_quantile(0.95, rate(thoughtgate_approval_duration_seconds_bucket[5m]))\n"})}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Active Tasks"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-promql",children:"thoughtgate_tasks_active\n"})}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Upstream Error Rate"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-promql",children:'sum(rate(thoughtgate_upstream_requests_total{status="error"}[5m])) /\nsum(rate(thoughtgate_upstream_requests_total[5m]))\n'})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(t.h3,{id:"recommended-alerts",children:"Recommended Alerts"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:'# alerting_rules.yml\ngroups:\n  - name: thoughtgate\n    rules:\n      # High denial rate\n      - alert: ThoughtGateHighDenialRate\n        expr: |\n          sum(rate(thoughtgate_requests_total{action="deny"}[5m])) /\n          sum(rate(thoughtgate_requests_total[5m])) > 0.1\n        for: 5m\n        labels:\n          severity: warning\n        annotations:\n          summary: "High denial rate ({{ $value | humanizePercentage }})"\n\n      # Upstream errors\n      - alert: ThoughtGateUpstreamErrors\n        expr: |\n          sum(rate(thoughtgate_upstream_requests_total{status="error"}[5m])) > 0\n        for: 2m\n        labels:\n          severity: critical\n        annotations:\n          summary: "Upstream connection errors"\n\n      # Approval timeouts\n      - alert: ThoughtGateApprovalTimeouts\n        expr: |\n          sum(rate(thoughtgate_approval_total{result="timeout"}[5m])) > 0\n        for: 5m\n        labels:\n          severity: warning\n        annotations:\n          summary: "Approvals timing out"\n\n      # Not ready\n      - alert: ThoughtGateNotReady\n        expr: up{job="thoughtgate"} == 1 and thoughtgate_ready == 0\n        for: 1m\n        labels:\n          severity: critical\n        annotations:\n          summary: "ThoughtGate not ready to serve traffic"\n'})}),"\n",(0,r.jsx)(t.h2,{id:"logging",children:"Logging"}),"\n",(0,r.jsxs)(t.p,{children:["ThoughtGate uses structured JSON logging via ",(0,r.jsx)(t.code,{children:"tracing"}),":"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-json",children:'{\n  "timestamp": "2025-01-25T10:30:00.000Z",\n  "level": "INFO",\n  "target": "thoughtgate::governance",\n  "message": "Request evaluated",\n  "fields": {\n    "method": "tools/call",\n    "tool_name": "delete_user",\n    "action": "approve",\n    "task_id": "tg_abc123"\n  }\n}\n'})}),"\n",(0,r.jsx)(t.h3,{id:"log-levels",children:"Log Levels"}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:"Level"}),(0,r.jsx)(t.th,{children:"Use"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"ERROR"})}),(0,r.jsx)(t.td,{children:"Failures requiring attention"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"WARN"})}),(0,r.jsx)(t.td,{children:"Degraded operation"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"INFO"})}),(0,r.jsx)(t.td,{children:"Normal operation events"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"DEBUG"})}),(0,r.jsx)(t.td,{children:"Detailed flow for troubleshooting"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"TRACE"})}),(0,r.jsx)(t.td,{children:"Very verbose (development only)"})]})]})]}),"\n",(0,r.jsxs)(t.p,{children:["Configure via ",(0,r.jsx)(t.code,{children:"RUST_LOG"}),":"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"# Production\nexport RUST_LOG=thoughtgate=info\n\n# Troubleshooting\nexport RUST_LOG=thoughtgate=debug\n\n# Full trace (verbose)\nexport RUST_LOG=thoughtgate=trace\n"})}),"\n",(0,r.jsx)(t.h3,{id:"sensitive-data",children:"Sensitive Data"}),"\n",(0,r.jsxs)(t.p,{children:["ThoughtGate ",(0,r.jsx)(t.strong,{children:"never logs"}),":"]}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"Tool arguments (may contain secrets)"}),"\n",(0,r.jsx)(t.li,{children:"Authorization headers"}),"\n",(0,r.jsx)(t.li,{children:"Slack bot tokens"}),"\n",(0,r.jsx)(t.li,{children:"API keys"}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"distributed-tracing",children:"Distributed Tracing"}),"\n",(0,r.jsx)(t.p,{children:"ThoughtGate supports OpenTelemetry tracing (v0.3+). Configure the OTLP endpoint:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"export OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317\n"})}),"\n",(0,r.jsx)(t.p,{children:"Each request gets a trace ID that flows through:"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsx)(t.li,{children:"Agent \u2192 ThoughtGate"}),"\n",(0,r.jsx)(t.li,{children:"ThoughtGate \u2192 Upstream"}),"\n",(0,r.jsx)(t.li,{children:"ThoughtGate \u2192 Slack (for approvals)"}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"troubleshooting-with-metrics",children:"Troubleshooting with Metrics"}),"\n",(0,r.jsx)(t.h3,{id:"requests-are-slow",children:'"Requests are slow"'}),"\n",(0,r.jsx)(t.p,{children:"Check latency breakdown:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-promql",children:"# Overall latency\nhistogram_quantile(0.95, rate(thoughtgate_request_duration_seconds_bucket[5m]))\n\n# Is it upstream?\nhistogram_quantile(0.95, rate(thoughtgate_upstream_duration_seconds_bucket[5m]))\n\n# Is it policy evaluation?\nhistogram_quantile(0.95, rate(thoughtgate_policy_eval_seconds_bucket[5m]))\n"})}),"\n",(0,r.jsx)(t.h3,{id:"approvals-are-getting-stuck",children:'"Approvals are getting stuck"'}),"\n",(0,r.jsx)(t.p,{children:"Check task metrics:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-promql",children:'# Active tasks (should not grow unbounded)\nthoughtgate_tasks_active\n\n# Timeout rate\nrate(thoughtgate_approval_total{result="timeout"}[5m])\n'})}),"\n",(0,r.jsx)(t.h3,{id:"high-memory-usage",children:'"High memory usage"'}),"\n",(0,r.jsx)(t.p,{children:"Check active connections:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-promql",children:"# Active streams\ngreen_path_streams_active\n\n# Buffer usage (for approve path)\nthoughtgate_buffer_bytes_total\n"})}),"\n",(0,r.jsx)(t.h2,{id:"resource-recommendations",children:"Resource Recommendations"}),"\n",(0,r.jsx)(t.p,{children:"For sidecar deployment:"}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:"Resource"}),(0,r.jsx)(t.th,{children:"Request"}),(0,r.jsx)(t.th,{children:"Limit"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"CPU"}),(0,r.jsx)(t.td,{children:"50m"}),(0,r.jsx)(t.td,{children:"200m"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Memory"}),(0,r.jsx)(t.td,{children:"50Mi"}),(0,r.jsx)(t.td,{children:"100Mi"})]})]})]}),"\n",(0,r.jsx)(t.p,{children:"ThoughtGate is designed to be lightweight:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"Idle memory: < 20 MB"}),"\n",(0,r.jsx)(t.li,{children:"Per-request overhead: < 2 ms"}),"\n",(0,r.jsx)(t.li,{children:"Cold start: < 100 ms"}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.a,{href:"/docs/how-to/deploy-kubernetes",children:"Deploy to Kubernetes"})," \u2014 Full deployment guide"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.a,{href:"/docs/how-to/troubleshoot",children:"Troubleshoot Common Issues"})," \u2014 Problem-solving guide"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.a,{href:"/docs/explanation/architecture",children:"Architecture"})," \u2014 Understand the 4-Gate model"]}),"\n"]})]})}function c(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453(e,t,n){n.d(t,{R:()=>o,x:()=>a});var s=n(6540);const r={},i=s.createContext(r);function o(e){const t=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(i.Provider,{value:t},e.children)}}}]);