"use strict";(globalThis.webpackChunkthoughtgate_docs=globalThis.webpackChunkthoughtgate_docs||[]).push([[810],{8453(e,n,s){s.d(n,{R:()=>t,x:()=>d});var r=s(6540);const i={},l=r.createContext(i);function t(e){const n=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),r.createElement(l.Provider,{value:n},e.children)}},9477(e,n,s){s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>h,frontMatter:()=>t,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"explanation/architecture","title":"Architecture","description":"ThoughtGate is a governance layer that sits between AI agents and MCP servers. It operates in two deployment modes: a CLI wrapper for local development and an HTTP sidecar for server deployments.","source":"@site/docs/explanation/architecture.md","sourceDirName":"explanation","slug":"/explanation/architecture","permalink":"/pr-preview/55/docs/explanation/architecture","draft":false,"unlisted":false,"editUrl":"https://github.com/thoughtgate/thoughtgate/tree/main/website/docs/explanation/architecture.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"docsSidebar","previous":{"title":"Why ThoughtGate","permalink":"/pr-preview/55/docs/explanation/why-thoughtgate"},"next":{"title":"Traffic Routing","permalink":"/pr-preview/55/docs/explanation/traffic-tiers"}}');var i=s(4848),l=s(8453);const t={sidebar_position:2},d="Architecture",a={},c=[{value:"Deployment Modes",id:"deployment-modes",level:2},{value:"CLI Wrapper (Local Development)",id:"cli-wrapper-local-development",level:3},{value:"HTTP Sidecar (Kubernetes)",id:"http-sidecar-kubernetes",level:3},{value:"Workspace Structure",id:"workspace-structure",level:2},{value:"4-Gate Decision Model",id:"4-gate-decision-model",level:2},{value:"Components",id:"components",level:2},{value:"1. Transport Layer",id:"1-transport-layer",level:3},{value:"2. Governance Engine",id:"2-governance-engine",level:3},{value:"3. Cedar Policy Engine (Optional)",id:"3-cedar-policy-engine-optional",level:3},{value:"4. Task Manager",id:"4-task-manager",level:3},{value:"5. Approval Adapter",id:"5-approval-adapter",level:3},{value:"6. Admin Server",id:"6-admin-server",level:3},{value:"Stdio Transport (CLI Wrapper)",id:"stdio-transport-cli-wrapper",level:2},{value:"Shim Subprocess Model",id:"shim-subprocess-model",level:3},{value:"NDJSON Wire Format",id:"ndjson-wire-format",level:3},{value:"Passthrough Methods",id:"passthrough-methods",level:3},{value:"Shutdown Coordination",id:"shutdown-coordination",level:3},{value:"Port Model (HTTP Sidecar)",id:"port-model-http-sidecar",level:2},{value:"Request Flow",id:"request-flow",level:2},{value:"Forward Path (No Approval)",id:"forward-path-no-approval",level:3},{value:"Approval Path (SEP-1686)",id:"approval-path-sep-1686",level:3},{value:"State Management",id:"state-management",level:2},{value:"In-Memory (v0.2\u2013v0.3)",id:"in-memory-v02v03",level:3},{value:"Future: Persistent State (v0.4+)",id:"future-persistent-state-v04",level:3},{value:"Deployment Models",id:"deployment-models",level:2},{value:"CLI Wrapper (Local)",id:"cli-wrapper-local",level:3},{value:"HTTP Sidecar (Kubernetes)",id:"http-sidecar-kubernetes-1",level:3},{value:"Performance Characteristics",id:"performance-characteristics",level:2},{value:"Failure Modes",id:"failure-modes",level:2},{value:"Upstream Unavailable",id:"upstream-unavailable",level:3},{value:"Policy Error",id:"policy-error",level:3},{value:"Slack Unavailable",id:"slack-unavailable",level:3},{value:"Next Steps",id:"next-steps",level:2}];function o(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"architecture",children:"Architecture"})}),"\n",(0,i.jsxs)(n.p,{children:["ThoughtGate is a governance layer that sits between AI agents and MCP servers. It operates in two deployment modes: a ",(0,i.jsx)(n.strong,{children:"CLI wrapper"})," for local development and an ",(0,i.jsx)(n.strong,{children:"HTTP sidecar"})," for server deployments."]}),"\n",(0,i.jsx)(n.h2,{id:"deployment-modes",children:"Deployment Modes"}),"\n",(0,i.jsx)(n.h3,{id:"cli-wrapper-local-development",children:"CLI Wrapper (Local Development)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  AI Agent   \u2502     \u2502            thoughtgate wrap               \u2502     \u2502  MCP Server \u2502\n\u2502  (Claude    \u2502     \u2502                                          \u2502     \u2502  (stdio)    \u2502\n\u2502   Code,     \u2502     \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502     \u2502             \u2502\n\u2502   Cursor,   \u2502\u25c0\u2550\u2550\u2550\u25b6\u2502  \u2502  Shim    \u2502\u25c0\u2550\u2550\u25b6\u2502 Governance Svc   \u2502   \u2502\u25c0\u2550\u2550\u2550\u25b6\u2502             \u2502\n\u2502   etc.)     \u2502stdio\u2502  \u2502 (per MCP)\u2502    \u2502 (127.0.0.1:auto) \u2502   \u2502stdio\u2502             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The CLI wrapper rewrites the agent's MCP config so each server's command is replaced with a ThoughtGate ",(0,i.jsx)(n.strong,{children:"shim"})," process. The shim intercepts NDJSON JSON-RPC messages on stdin/stdout and consults a local ",(0,i.jsx)(n.strong,{children:"governance service"})," (HTTP, bound to ",(0,i.jsx)(n.code,{children:"127.0.0.1"})," on an ephemeral port) before forwarding."]}),"\n",(0,i.jsx)(n.h3,{id:"http-sidecar-kubernetes",children:"HTTP Sidecar (Kubernetes)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  AI Agent   \u2502\u2500\u2500\u2500\u2500\u25b6\u2502           ThoughtGate               \u2502\u2500\u2500\u2500\u2500\u25b6\u2502  MCP Server \u2502\n\u2502  (Claude,   \u2502\u25c0\u2500\u2500\u2500\u2500\u2502                                     \u2502\u25c0\u2500\u2500\u2500\u2500\u2502  (HTTP)     \u2502\n\u2502   GPT, etc) \u2502     \u2502  Outbound: 7467    Admin: 7469      \u2502     \u2502             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,i.jsx)(n.p,{children:"The HTTP sidecar runs as a separate container, proxying JSON-RPC over HTTP. The agent connects to ThoughtGate's outbound port instead of the upstream MCP server directly."}),"\n",(0,i.jsx)(n.h2,{id:"workspace-structure",children:"Workspace Structure"}),"\n",(0,i.jsx)(n.p,{children:"ThoughtGate is organized as a Rust workspace with three crates:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Crate"}),(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:"Purpose"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"thoughtgate-core"})}),(0,i.jsx)(n.td,{children:"Library"}),(0,i.jsx)(n.td,{children:"Transport-agnostic governance, policy, telemetry"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"thoughtgate-proxy"})}),(0,i.jsx)(n.td,{children:"Binary"}),(0,i.jsx)(n.td,{children:"HTTP sidecar for Kubernetes deployments"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"thoughtgate"})}),(0,i.jsx)(n.td,{children:"Binary"}),(0,i.jsx)(n.td,{children:"CLI wrapper for local development"})]})]})]}),"\n",(0,i.jsx)(n.p,{children:"The core library is shared between both binaries, ensuring identical governance logic regardless of transport."}),"\n",(0,i.jsx)(n.h2,{id:"4-gate-decision-model",children:"4-Gate Decision Model"}),"\n",(0,i.jsx)(n.p,{children:"ThoughtGate evaluates every request through a 4-gate pipeline:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502                    THOUGHTGATE                          \u2502\n                    \u2502                                                         \u2502\n  MCP Request \u2500\u2500\u2500\u2500\u2500\u25b6\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n                    \u2502  \u2502  Gate 1  \u2502\u2500\u2500\u2500\u25b6\u2502  Gate 2  \u2502\u2500\u2500\u2500\u25b6\u2502     Gate 3/4     \u2502  \u2502\n                    \u2502  \u2502Visibility\u2502    \u2502  Rules   \u2502    \u2502                  \u2502  \u2502\n                    \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502  forward \u2500\u2500\u25b6 \u2713   \u2502  \u2502\n                    \u2502                                  \u2502  deny \u2500\u2500\u2500\u2500\u25b6 \u2717   \u2502  \u2502\n                    \u2502                                  \u2502  approve \u2500\u25b6 Task \u2502  \u2502\n                    \u2502                                  \u2502  policy \u2500\u2500\u25b6 Cedar\u2502  \u2502\n                    \u2502                                  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n                    \u2502                                                         \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Gate"}),(0,i.jsx)(n.th,{children:"Name"}),(0,i.jsx)(n.th,{children:"Purpose"}),(0,i.jsx)(n.th,{children:"Configuration"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Gate 1"})}),(0,i.jsx)(n.td,{children:"Visibility"}),(0,i.jsx)(n.td,{children:"Filter which tools agents can see"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"sources[].expose"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Gate 2"})}),(0,i.jsx)(n.td,{children:"Governance Rules"}),(0,i.jsx)(n.td,{children:"YAML pattern matching"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"governance.rules[]"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Gate 3"})}),(0,i.jsx)(n.td,{children:"Cedar Policy"}),(0,i.jsx)(n.td,{children:"Complex access control"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"cedar.policy_path"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Gate 4"})}),(0,i.jsx)(n.td,{children:"Human Approval"}),(0,i.jsx)(n.td,{children:"Slack-based approval workflow"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"approval.*"})})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"components",children:"Components"}),"\n",(0,i.jsx)(n.h3,{id:"1-transport-layer",children:"1. Transport Layer"}),"\n",(0,i.jsx)(n.p,{children:"Handles JSON-RPC 2.0 message parsing and routing:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Parses incoming MCP requests"}),"\n",(0,i.jsx)(n.li,{children:"Preserves request ID types (string, number, null)"}),"\n",(0,i.jsx)(n.li,{children:"Routes responses back to clients"}),"\n",(0,i.jsx)(n.li,{children:"Manages connection pooling to upstream"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"2-governance-engine",children:"2. Governance Engine"}),"\n",(0,i.jsx)(n.p,{children:"Evaluates requests against YAML rules:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Pattern matching with glob syntax"}),"\n",(0,i.jsx)(n.li,{children:"First-match-wins evaluation"}),"\n",(0,i.jsxs)(n.li,{children:["Routes to Cedar when ",(0,i.jsx)(n.code,{children:"action: policy"})]}),"\n",(0,i.jsxs)(n.li,{children:["Creates tasks when ",(0,i.jsx)(n.code,{children:"action: approve"})]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"3-cedar-policy-engine-optional",children:"3. Cedar Policy Engine (Optional)"}),"\n",(0,i.jsx)(n.p,{children:"For complex access control:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"AWS Cedar policy language"}),"\n",(0,i.jsx)(n.li,{children:"Hot-reloadable policies"}),"\n",(0,i.jsx)(n.li,{children:"Attribute-based access control"}),"\n",(0,i.jsx)(n.li,{children:"Condition evaluation on arguments"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"4-task-manager",children:"4. Task Manager"}),"\n",(0,i.jsx)(n.p,{children:"Manages SEP-1686 async tasks:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Creates tasks for approval requests"}),"\n",(0,i.jsx)(n.li,{children:"Tracks task state (working, completed, failed, rejected)"}),"\n",(0,i.jsx)(n.li,{children:"Handles timeouts and cancellation"}),"\n",(0,i.jsx)(n.li,{children:"Stores results for retrieval"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"5-approval-adapter",children:"5. Approval Adapter"}),"\n",(0,i.jsx)(n.p,{children:"Slack integration for human-in-the-loop:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Posts approval messages with Block Kit"}),"\n",(0,i.jsx)(n.li,{children:"Polls for reactions (\ud83d\udc4d/\ud83d\udc4e)"}),"\n",(0,i.jsx)(n.li,{children:"Resolves user display names"}),"\n",(0,i.jsx)(n.li,{children:"Handles rate limiting"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"6-admin-server",children:"6. Admin Server"}),"\n",(0,i.jsx)(n.p,{children:"Provides operational endpoints:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"/health"})," \u2014 Liveness probe"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"/ready"})," \u2014 Readiness probe"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"/metrics"})," \u2014 Prometheus metrics"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"stdio-transport-cli-wrapper",children:"Stdio Transport (CLI Wrapper)"}),"\n",(0,i.jsxs)(n.p,{children:["In CLI wrapper mode, each MCP server gets its own ",(0,i.jsx)(n.strong,{children:"shim"})," subprocess:"]}),"\n",(0,i.jsx)(n.h3,{id:"shim-subprocess-model",children:"Shim Subprocess Model"}),"\n",(0,i.jsxs)(n.p,{children:["When ",(0,i.jsx)(n.code,{children:"thoughtgate wrap"})," launches an agent:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Config discovery"})," \u2014 Detects the agent type, reads its config file"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Config rewrite"})," \u2014 Replaces each stdio server's ",(0,i.jsx)(n.code,{children:"command"})," with ",(0,i.jsx)(n.code,{children:"thoughtgate shim ..."})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Governance service start"})," \u2014 Starts an HTTP service on ",(0,i.jsx)(n.code,{children:"127.0.0.1"})," (ephemeral port)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Agent launch"})," \u2014 Starts the agent, which spawns shim processes as it connects to MCP servers"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Per-server proxy"})," \u2014 Each shim reads NDJSON from stdin/stdout, consults governance service, forwards or blocks"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"ndjson-wire-format",children:"NDJSON Wire Format"}),"\n",(0,i.jsxs)(n.p,{children:["Stdio MCP servers use newline-delimited JSON-RPC (NDJSON). Each line is a complete JSON-RPC message terminated by ",(0,i.jsx)(n.code,{children:"0x0A"}),". The shim:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Splits input on newline boundaries"}),"\n",(0,i.jsx)(n.li,{children:"Parses each line as a JSON-RPC message"}),"\n",(0,i.jsxs)(n.li,{children:["Checks for smuggling (multiple ",(0,i.jsx)(n.code,{children:"jsonrpc"})," keys in a single line)"]}),"\n",(0,i.jsxs)(n.li,{children:["Routes ",(0,i.jsx)(n.code,{children:"tools/call"})," requests through governance evaluation"]}),"\n",(0,i.jsx)(n.li,{children:"Passes through non-governed methods (see below)"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"passthrough-methods",children:"Passthrough Methods"}),"\n",(0,i.jsx)(n.p,{children:"These methods bypass governance and are forwarded directly:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"initialize"})," \u2014 MCP session setup"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ping"})," \u2014 Health check"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"notifications/*"})," \u2014 All notification methods"]}),"\n",(0,i.jsxs)(n.li,{children:["Any method that is not ",(0,i.jsx)(n.code,{children:"tools/call"})]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Only ",(0,i.jsx)(n.code,{children:"tools/call"})," requests are evaluated against governance rules."]}),"\n",(0,i.jsx)(n.h3,{id:"shutdown-coordination",children:"Shutdown Coordination"}),"\n",(0,i.jsx)(n.p,{children:"When the agent exits or ThoughtGate receives a signal:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Stdin to each shim is closed"}),"\n",(0,i.jsxs)(n.li,{children:["Shims forward ",(0,i.jsx)(n.code,{children:"SIGTERM"})," to upstream servers"]}),"\n",(0,i.jsxs)(n.li,{children:["After a grace period, ",(0,i.jsx)(n.code,{children:"SIGKILL"})," is sent"]}),"\n",(0,i.jsx)(n.li,{children:"Original agent config is restored from backup"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"port-model-http-sidecar",children:"Port Model (HTTP Sidecar)"}),"\n",(0,i.jsx)(n.p,{children:"In HTTP sidecar mode, ThoughtGate uses an Envoy-inspired 3-port architecture:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Port"}),(0,i.jsx)(n.th,{children:"Name"}),(0,i.jsx)(n.th,{children:"Purpose"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"7467"}),(0,i.jsx)(n.td,{children:"Outbound"}),(0,i.jsx)(n.td,{children:"Client requests \u2192 upstream (main proxy)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"7468"}),(0,i.jsx)(n.td,{children:"Inbound"}),(0,i.jsx)(n.td,{children:"Reserved for webhooks"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"7469"}),(0,i.jsx)(n.td,{children:"Admin"}),(0,i.jsx)(n.td,{children:"Health checks, metrics"})]})]})]}),"\n",(0,i.jsx)(n.p,{children:"This separation ensures health checks don't interfere with proxy traffic and allows different security policies per port."}),"\n",(0,i.jsx)(n.h2,{id:"request-flow",children:"Request Flow"}),"\n",(0,i.jsx)(n.h3,{id:"forward-path-no-approval",children:"Forward Path (No Approval)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Agent \u2192 ThoughtGate \u2192 Upstream \u2192 ThoughtGate \u2192 Agent\n       (Gate 1-2: forward)\n"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Agent sends ",(0,i.jsx)(n.code,{children:"tools/call"})," request"]}),"\n",(0,i.jsx)(n.li,{children:"Gate 1 checks visibility (pass)"}),"\n",(0,i.jsxs)(n.li,{children:["Gate 2 matches rule \u2192 ",(0,i.jsx)(n.code,{children:"action: forward"})]}),"\n",(0,i.jsx)(n.li,{children:"Request forwarded to upstream"}),"\n",(0,i.jsx)(n.li,{children:"Response returned to agent"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"approval-path-sep-1686",children:"Approval Path (SEP-1686)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Agent \u2192 ThoughtGate \u2192 Task Created \u2192 Slack \u2192 Human \u2192 ThoughtGate \u2192 Upstream\n       (Gate 1-2: approve)    (polls)   (reacts)  (executes)\n"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Agent sends ",(0,i.jsx)(n.code,{children:"tools/call"})," request"]}),"\n",(0,i.jsx)(n.li,{children:"Gate 1 checks visibility (pass)"}),"\n",(0,i.jsxs)(n.li,{children:["Gate 2 matches rule \u2192 ",(0,i.jsx)(n.code,{children:"action: approve"})]}),"\n",(0,i.jsxs)(n.li,{children:["Task created with ID ",(0,i.jsx)(n.code,{children:"tg_abc123"})]}),"\n",(0,i.jsxs)(n.li,{children:["Immediate response: ",(0,i.jsx)(n.code,{children:'{taskId: "tg_abc123", status: "working"}'})]}),"\n",(0,i.jsx)(n.li,{children:"Slack message posted"}),"\n",(0,i.jsxs)(n.li,{children:["Agent polls ",(0,i.jsx)(n.code,{children:"tasks/get"})]}),"\n",(0,i.jsx)(n.li,{children:"Human reacts \ud83d\udc4d"}),"\n",(0,i.jsxs)(n.li,{children:["Task status \u2192 ",(0,i.jsx)(n.code,{children:"completed"})]}),"\n",(0,i.jsxs)(n.li,{children:["Agent calls ",(0,i.jsx)(n.code,{children:"tasks/result"})," to get upstream response"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"state-management",children:"State Management"}),"\n",(0,i.jsx)(n.h3,{id:"in-memory-v02v03",children:"In-Memory (v0.2\u2013v0.3)"}),"\n",(0,i.jsxs)(n.admonition,{title:"Ephemeral State",type:"warning",children:[(0,i.jsxs)(n.p,{children:["All task state is stored in an in-memory ",(0,i.jsx)(n.code,{children:"DashMap"}),". This means:"]}),(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Pending approvals are lost on restart"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Tasks cannot be shared across multiple instances"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"No persistence across deployments"})}),"\n"]}),(0,i.jsx)(n.p,{children:"Plan your deployment accordingly. For critical workflows, consider implementing retry logic in your agent to resubmit approval requests after ThoughtGate restarts."})]}),"\n",(0,i.jsx)(n.p,{children:"All state is held in memory:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Pending approval tasks (DashMap)"}),"\n",(0,i.jsx)(n.li,{children:"Connection pools"}),"\n",(0,i.jsx)(n.li,{children:"Configuration cache"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"future-persistent-state-v04",children:"Future: Persistent State (v0.4+)"}),"\n",(0,i.jsx)(n.p,{children:"Planned improvements:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Redis-backed task storage"}),"\n",(0,i.jsx)(n.li,{children:"Task state survives restarts"}),"\n",(0,i.jsx)(n.li,{children:"Multi-instance coordination"}),"\n",(0,i.jsx)(n.li,{children:"Horizontal scaling support"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"deployment-models",children:"Deployment Models"}),"\n",(0,i.jsx)(n.h3,{id:"cli-wrapper-local",children:"CLI Wrapper (Local)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"thoughtgate wrap -- claude-code\n"})}),"\n",(0,i.jsx)(n.p,{children:"Benefits:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Zero infrastructure setup"}),"\n",(0,i.jsx)(n.li,{children:"Works with any supported agent"}),"\n",(0,i.jsx)(n.li,{children:"Config automatically restored on exit"}),"\n",(0,i.jsx)(n.li,{children:"Development/production profile switching"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"http-sidecar-kubernetes-1",children:"HTTP Sidecar (Kubernetes)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"spec:\n  containers:\n    - name: agent          # Your AI agent\n    - name: thoughtgate    # Sidecar proxy\n"})}),"\n",(0,i.jsx)(n.p,{children:"Benefits:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"No network hop (localhost)"}),"\n",(0,i.jsx)(n.li,{children:"Per-agent isolation"}),"\n",(0,i.jsx)(n.li,{children:"Independent scaling"}),"\n",(0,i.jsx)(n.li,{children:"Zero-config identity from pod labels"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"performance-characteristics",children:"Performance Characteristics"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Path"}),(0,i.jsx)(n.th,{children:"Latency Overhead"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Forward"}),(0,i.jsx)(n.td,{children:"< 2 ms"}),(0,i.jsx)(n.td,{children:"Policy eval + forward"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Deny"}),(0,i.jsx)(n.td,{children:"< 1 ms"}),(0,i.jsx)(n.td,{children:"Policy eval + error"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Approve (initial)"}),(0,i.jsx)(n.td,{children:"< 5 ms"}),(0,i.jsx)(n.td,{children:"Task creation + Slack post"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Approve (total)"}),(0,i.jsx)(n.td,{children:"Seconds to minutes"}),(0,i.jsx)(n.td,{children:"Waiting for human"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"failure-modes",children:"Failure Modes"}),"\n",(0,i.jsx)(n.h3,{id:"upstream-unavailable",children:"Upstream Unavailable"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Request fails with ",(0,i.jsx)(n.code,{children:"-32000 UpstreamConnectionFailed"})]}),"\n",(0,i.jsx)(n.li,{children:"Readiness probe fails"}),"\n",(0,i.jsx)(n.li,{children:"Agent receives clear error"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"policy-error",children:"Policy Error"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Request denied (fail-safe)"}),"\n",(0,i.jsx)(n.li,{children:"Logged as error"}),"\n",(0,i.jsx)(n.li,{children:"Operator alerted via metrics"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"slack-unavailable",children:"Slack Unavailable"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Task created but approval stuck"}),"\n",(0,i.jsx)(n.li,{children:"Task eventually times out"}),"\n",(0,i.jsx)(n.li,{children:"Logged as error"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Understand the ",(0,i.jsx)(n.a,{href:"/docs/explanation/security-model",children:"Security Model"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/docs/tutorials/wrap-first-agent",children:"Wrap your first agent"})," (CLI wrapper tutorial)"]}),"\n",(0,i.jsxs)(n.li,{children:["Learn to ",(0,i.jsx)(n.a,{href:"/docs/how-to/write-policies",children:"write governance rules"})]}),"\n",(0,i.jsxs)(n.li,{children:["See the ",(0,i.jsx)(n.a,{href:"/docs/reference/cli",children:"CLI Reference"})," for all flags"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}}}]);