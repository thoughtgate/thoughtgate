# Tag Release
#
# Automatically creates a git tag when a release PR merges to main.
# The tag push triggers the Release workflow (release.yml) which builds
# binaries via cargo-dist and creates the GitHub Release.
#
# IMPORTANT: Set the RELEASE_TOKEN repository secret to a fine-grained PAT
# with "Contents: Read and write" permission. Without it, the tag push
# uses GITHUB_TOKEN which does NOT trigger downstream workflows.
#
# Setup:
#   1. Create a fine-grained PAT at https://github.com/settings/tokens
#      - Repository access: this repo only
#      - Permissions: Contents → Read and write
#   2. Save as repository secret named RELEASE_TOKEN
#      Settings → Secrets and variables → Actions → New repository secret

name: Tag Release

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  tag:
    name: Create release tag
    runs-on: ubuntu-latest
    if: >-
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'release/v')

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          # PAT ensures the tag push triggers release.yml (cargo-dist).
          # GITHUB_TOKEN-triggered events do not create new workflow runs.
          token: ${{ secrets.RELEASE_TOKEN || github.token }}

      - name: Create and push tag
        run: |
          VERSION="${{ github.event.pull_request.head.ref }}"
          VERSION="${VERSION#release/}"
          echo "Creating tag: $VERSION"
          git tag -a "$VERSION" -m "chore(release): $VERSION"
          git push origin "$VERSION"
