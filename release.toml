# cargo-release configuration for ThoughtGate
# https://github.com/crate-ci/cargo-release/blob/master/docs/reference.md
#
# Releases are triggered via the "Prepare Release" GitHub Actions workflow:
#   1. Go to Actions → Prepare Release → Run workflow
#   2. Enter the version (e.g. 0.4.0)
#   3. Review and merge the resulting PR
#   4. Tag Release workflow auto-creates the git tag
#   5. cargo-dist builds binaries and creates the GitHub Release
#
# Local dry-run (to preview changes):
#   cargo release patch
#   cargo release minor

# All workspace crates share a single version from [workspace.package]
shared-version = "workspace"

# No crates.io publishing — ThoughtGate distributes via cargo-dist binaries
publish = false

# Commit message follows conventional commits format
pre-release-commit-message = "chore(release): prepare v{{version}}"

# Run git-cliff to regenerate CHANGELOG.md before the release commit.
# cargo-release runs this hook from each crate's subdirectory, but we need
# git-cliff to cover the entire workspace and write to the workspace root.
# Using bash -c lets us expand $WORKSPACE_ROOT (set by cargo-release).
pre-release-hook = [
    "bash", "-c",
    "git-cliff --repository \"$WORKSPACE_ROOT\" --tag \"$1\" --output \"$WORKSPACE_ROOT/CHANGELOG.md\"",
    "--", "v{{version}}",
]

# Single commit for the entire workspace (version bump + changelog)
consolidate-commits = true

# CI workflow handles pushing to a release branch and creating a PR.
# cargo-release only creates the local commit (no push, no tag).
push = false
tag = false

# Only allow releases from the main branch
allow-branch = ["main"]

# When bumping workspace version, upgrade dependent crate versions too
dependent-version = "upgrade"
